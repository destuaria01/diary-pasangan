<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diary Pasangan ‚Äî Final</title>
<meta name="theme-color" content="#06b6a4">
<style>
  /* ---------- STYLE: fresh banking-like green theme ---------- */
  :root{
    --bg:#f6fffb;
    --card:#ffffff;
    --accent1:#06b6a4; /* teal-green */
    --accent2:#12b886;
    --accent3:#2dd4bf;
    --muted:#6b7280;
    --glass: rgba(255,255,255,0.8);
    --radius:14px;
    --shadow: 0 8px 20px rgba(6, 22, 24, 0.06);
    --success:#16a34a;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#0f172a;background:linear-gradient(180deg,#ecfdf5 0%, #f6fffb 100%);}
  .wrap{max-width:920px;margin:18px auto;padding:14px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent3));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(3,105,89,0.08)}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
  .row{display:flex;gap:12px;align-items:center}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="password"], input[type="number"], select, textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #e6f4ee;background:#fff;box-sizing:border-box;font-size:14px;color:#0f172a;
  }
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  button{padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-weight:600}
  .btn-accent{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
  .btn-soft{background:#f3fff9;color:var(--accent1);border:1px solid #dff6ef}
  .btn-danger{background:#ef4444;color:#fff}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:#334155}
  .center{text-align:center}
  .gap{height:8px}
  .pill{display:inline-block;padding:8px 12px;border-radius:999px;background:#f0fdf7;color:var(--accent1);font-weight:700}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:var(--accent1);color:#fff;font-weight:700;font-size:12px}
  /* timeline */
  .timeline-list{display:grid;gap:10px}
  .timeline-item{display:flex;gap:10px;align-items:flex-start;background:linear-gradient(180deg,#fff,#fbfffd);padding:10px;border-radius:10px;border:1px solid rgba(6,182,156,0.06)}
  .thumb{width:64px;height:64px;border-radius:8px;background:#f7fffb;display:flex;align-items:center;justify-content:center;border:1px solid #e6f9f3}
  .meta{flex:1}
  .meta h4{margin:0;font-size:14px}
  .meta p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
  .meta .t{font-size:12px;color:#94a3b8;margin-top:6px}
  .controls-inline{display:flex;gap:8px}
  .tiny{padding:6px 8px;border-radius:8px;border:1px solid #e6f4ee;background:#fff;font-size:13px}
  /* responsive */
  @media(max-width:720px){ .two{grid-template-columns:1fr} header{gap:8px} .logo{width:48px;height:48px} }
  /* toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#0f172a;color:#fff;padding:10px 16px;border-radius:10px;display:none;z-index:9999;box-shadow:0 8px 30px rgba(3,105,89,0.12)}
  /* input file style */
  .file-row{display:flex;gap:8px;align-items:center}
  /* green small icon */
  .icon{width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,var(--accent2),var(--accent3));display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">DP</div>
    <div>
      <h1>Diary Pasangan ‚Äî Final</h1>
      <div class="subtitle">Privat ¬∑ Offline-first ¬∑ Siap jadi APK ¬∑ Tampilan cerah hijau</div>
    </div>
  </header>

  <!-- LOGIN CARD -->
  <div id="lockCard" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="pill">üîê Masuk</div>
        <div class="muted" style="margin-top:8px">Masuk untuk menggunakan fitur diary lengkap</div>
      </div>
      <div class="badge" id="statusBadge">Offline</div>
    </div>

    <div class="gap"></div>
    <label>Masuk sebagai</label>
    <select id="loginAs">
      <option value="admin">Admin</option>
      <option value="A">Pasangan A</option>
      <option value="B">Pasangan B</option>
    </select>

    <div class="gap"></div>
    <label>PIN</label>
    <input id="pinInput" type="password" placeholder="PIN" />

    <div style="margin-top:10px" class="actions">
      <button class="btn-accent" onclick="checkPin()">Masuk</button>
      <button class="tiny" onclick="openSettings()">Pengaturan</button>
      <button class="tiny" onclick="openPinManager()">Kelola PIN</button>
    </div>
    <div style="margin-top:8px" class="muted">PIN default: admin=1234, A=1111, B=2222</div>
  </div>

  <!-- APP AREA -->
  <div id="app" style="display:none">
    <!-- Profile & Quick settings -->
    <div class="card">
      <div class="two">
        <div>
          <label>Nama Pasangan A</label>
          <input id="nameA" type="text" />
        </div>
        <div>
          <label>Nama Pasangan B</label>
          <input id="nameB" type="text" />
        </div>
      </div>

      <div class="gap"></div>
      <div class="two">
        <div>
          <label>PIN A</label>
          <input id="pinA" type="password" />
        </div>
        <div>
          <label>PIN B</label>
          <input id="pinB" type="password" />
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="autoLock" type="number" min="0" placeholder="Auto-lock (menit)" style="width:160px"/>
        <button class="btn-soft" onclick="saveProfile()">Simpan Profil</button>
        <button class="tiny" onclick="requestNotif()">Izinkan Notif</button>
        <button class="tiny" onclick="downloadBackup()">Download Backup</button>
      </div>
    </div>

    <!-- Absensi -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Absensi (ChekLok)</strong><div class="muted">Keluar / Pulang wajib foto selfie (kamera depan). "Sudah Sampai" tanpa selfie (opsional).</div></div>
        <div class="icon">üìç</div>
      </div>

      <div style="margin-top:12px" class="two">
        <div>
          <label>Pilih Orang</label>
          <select id="personSel">
            <option value="A">Pasangan A</option>
            <option value="B">Pasangan B</option>
          </select>
        </div>
        <div>
          <label>Pilih Lokasi (untuk 'Sudah Sampai')</label>
          <select id="arrivalPlace">
            <option value="Rumah">Rumah</option>
            <option value="Kampus">Kampus</option>
            <option value="Lainnya">Lain-lain</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="actions">
        <button class="btn-accent" onclick="startAction('keluar')">Keluar</button>
        <button class="btn-accent" onclick="startAction('pulang')">Pulang</button>
        <button class="tiny" onclick="startAction('sampai')">Sudah Sampai</button>
      </div>

      <div style="margin-top:10px" class="muted">Foto bukti disimpan lokal; bisa dihapus kapan saja.</div>
    </div>

    <!-- Upload aktivitas harian -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Upload Aktivitas Harian</strong><div class="muted">Unggah foto kegiatan (tidak dibatasi 2MB). Sertakan keterangan.</div></div>
        <div class="icon">üì∏</div>
      </div>

      <div style="margin-top:10px">
        <label>Siapa</label>
        <select id="actPerson"><option value="A">Pasangan A</option><option value="B">Pasangan B</option></select>
        <label style="margin-top:8px">Keterangan</label>
        <input id="actNote" type="text" placeholder="Contoh: Makan siang, tugas, belanja..." />
        <div style="margin-top:8px" class="file-row">
          <input id="actFile" type="file" accept="image/*" />
          <button class="btn-accent" onclick="uploadActivity()">Upload</button>
          <button class="tiny" onclick="renderGallery()">Buka Galeri</button>
        </div>
      </div>
    </div>

    <!-- Timeline & Grafik -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Timeline & Riwayat</strong><div class="muted">Lihat riwayat Keluar/Pulang/Sampai & Upload aktivitas.</div></div>
        <div><button class="tiny" onclick="renderTimeline()">Buka Timeline</button></div>
      </div>

      <div style="margin-top:10px" id="timelineWrap"></div>
    </div>

    <!-- Storage & backup -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Storage Foto & Backup</strong><div class="muted">Perkiraan penggunaan localStorage dan cara membersihkan.</div></div>
        <div class="muted" id="storageEst">--</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-soft" onclick="cleanOldPhotos()">Bersihkan Foto Lama</button>
        <button class="tiny" onclick="resetAll()">Reset Semua</button>
        <button class="btn-accent" onclick="downloadBackup()">Backup (.json)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(event)" />
        <button class="tiny" onclick="document.getElementById('importFile').click()">Restore (.json)</button>
      </div>
    </div>

    <!-- Hidden file input for camera selfie -->
    <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none"/>
    <input id="cameraFront" type="file" accept="image/*" capture="user" style="display:none"/>

  </div> <!-- end app -->

</div>

<div id="toast"></div>

<script>
/* =========================
   Diary Pasangan ‚Äî FINAL single file
   All data stored in localStorage keys
   ========================= */

/* Storage keys */
const KEY_DATA = "dp_data_final_v2";         // records array
const KEY_PROFILE = "dp_profile_final_v2";   // names + pins + settings
const KEY_ACTS = "dp_activity_photos_v2";    // uploaded daily photos

/* initial or load */
let data = JSON.parse(localStorage.getItem(KEY_DATA)) || [];
let acts = JSON.parse(localStorage.getItem(KEY_ACTS)) || [];
let profile = JSON.parse(localStorage.getItem(KEY_PROFILE)) || {
  nameA:"Pasangan A", nameB:"Pasangan B",
  pinAdmin:"1234", pinA:"1111", pinB:"2222",
  autoLock:5
};

/* ui refs */
const lockCard = document.getElementById("lockCard");
const app = document.getElementById("app");
const toastEl = document.getElementById("toast");

/* apply profile to UI fields */
function applyProfileToUI(){
  document.getElementById("nameA").value = profile.nameA || "";
  document.getElementById("nameB").value = profile.nameB || "";
  document.getElementById("pinA").value = profile.pinA || "";
  document.getElementById("pinB").value = profile.pinB || "";
  document.getElementById("autoLock").value = profile.autoLock || 5;
  // status offline/online attempt
  document.getElementById("statusBadge").innerText = navigator.onLine ? "Online" : "Offline";
}
applyProfileToUI();

/* toast helper */
function toast(msg, time=2200){
  toastEl.innerText = msg;
  toastEl.style.display = "block";
  setTimeout(()=>{ toastEl.style.display = "none"; }, time);
}

/* save all */
function saveAll(){ localStorage.setItem(KEY_DATA, JSON.stringify(data)); localStorage.setItem(KEY_ACTS, JSON.stringify(acts)); localStorage.setItem(KEY_PROFILE, JSON.stringify(profile)); updateStorageEstimate(); }

/* notif permission */
function requestNotif(){ if(!("Notification" in window)){ alert("Notifikasi tidak didukung browser ini"); return; } Notification.requestPermission().then(r => toast("Notification: "+r)); }

/* check PIN + login */
function checkPin(){
  const as = document.getElementById("loginAs").value;
  const v = (document.getElementById("pinInput")).value || "";
  let ok=false;
  if(as==='admin' && v === profile.pinAdmin) ok=true;
  if(as==='A' && v === profile.pinA) ok=true;
  if(as==='B' && v === profile.pinB) ok=true;
  if(ok){
    lockCard.style.display = "none";
    app.style.display = "block";
    toast("Login berhasil");
    renderTimeline();
    updateStorageEstimate();
  } else {
    alert("PIN salah");
  }
}

/* open settings (admin prompt) */
function openSettings(){
  const adm = prompt("Masukkan PIN admin untuk buka pengaturan:");
  if(adm === profile.pinAdmin){ alert("Mode admin: pengaturan terbuka di bawah."); lockCard.style.display='none'; app.style.display='block'; } else alert("PIN admin salah");
}

/* change PINs / profile */
function openPinManager(){ const who = prompt("Kelola PIN (admin / A / B) ?"); if(!who) return; const w = who.toLowerCase(); let curr = w==='admin'?profile.pinAdmin:(w==='a'?profile.pinA:profile.pinB); const oldp = prompt("PIN lama:"); if(oldp !== curr) return alert("PIN lama salah"); const neu = prompt("Masukkan PIN baru (min 4):"); if(!neu || neu.length<4) return alert("PIN minimal 4"); if(w==='admin') profile.pinAdmin = neu; else if(w==='a') profile.pinA = neu; else profile.pinB = neu; saveAll(); toast("PIN diubah"); applyProfileToUI(); }

/* save profile */
function saveProfile(){ profile.nameA = document.getElementById("nameA").value || "Pasangan A"; profile.nameB = document.getElementById("nameB").value || "Pasangan B"; profile.pinA = document.getElementById("pinA").value || profile.pinA; profile.pinB = document.getElementById("pinB").value || profile.pinB; profile.autoLock = Number(document.getElementById("autoLock").value || 0); saveAll(); toast("Profil tersimpan"); }

/* ACTION flow: Keluar / Pulang / Sudah Sampai */
let pendingAction = null;
function startAction(type){
  const person = document.getElementById("personSel").value;
  pendingAction = {person,type};
  if(type==='sampai'){
    // pilih place and optional photo
    const place = document.getElementById("arrivalPlace").value || "Rumah";
    // optional photo: allow user to pick file or skip
    const want = confirm("Sertakan foto bukti? Tekan OK untuk ambil foto (kamera) atau Cancel untuk lanjut tanpa foto.");
    if(want){
      const input = document.getElementById("cameraFront");
      input.onchange = (e)=> handleCameraFile(e, true, place);
      input.click();
    } else {
      // no photo, just push
      pushRecord(person, 'sampai', null, place);
    }
  } else {
    // require selfie (front camera)
    const input = document.getElementById("cameraFront");
    input.onchange = (e)=> handleCameraFile(e, true);
    input.click();
  }
}

/* camera handler for front/back: if front==true use cameraFront */
function handleCameraFile(e, front=false, placeOverride=null){
  const f = e.target.files[0];
  if(!f){ toast("Foto tidak dipilih"); return; }
  const reader = new FileReader();
  reader.onload = ()=> {
    const dataUrl = reader.result;
    // try geolocation
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const loc = pos.coords.latitude.toFixed(6)+","+pos.coords.longitude.toFixed(6);
        if(pendingAction){
          const place = placeOverride || "";
          pushRecord(pendingAction.person, pendingAction.type, dataUrl, place || loc);
        }
      }, err=>{
        if(pendingAction){
          const place = placeOverride || "Lokasi gagal";
          pushRecord(pendingAction.person, pendingAction.type, dataUrl, place);
        }
      }, {enableHighAccuracy:true, timeout:7000});
    } else {
      const place = placeOverride || "Lokasi tidak tersedia";
      pushRecord(pendingAction.person, pendingAction.type, dataUrl, place);
    }
  };
  reader.readAsDataURL(f);
  // reset
  e.target.value = "";
}

/* push record - central */
function pushRecord(person, type, photoDataUrl, location){
  const now = new Date();
  const timeISO = now.toISOString();
  const timeStr = now.toLocaleString();
  const rec = {person,type,timeISO,timeStr,location:location||"",photo:photoDataUrl||null};
  // if type pulang/keluar require photo: if no photo return error
  if((type==='keluar' || type==='pulang') && !photoDataUrl){
    alert("Foto selfie wajib untuk jenis ini.");
    return;
  }
  data.push(rec);
  saveAll();
  pendingAction = null;
  toast("Tersimpan: "+type.toUpperCase());
  renderTimeline();
}

/* render timeline */
function renderTimeline(){
  const wrap = document.getElementById("timelineWrap");
  wrap.innerHTML = "";
  // sort by time desc
  const arr = data.slice().sort((a,b)=> b.timeISO.localeCompare(a.timeISO));
  if(arr.length===0){
    wrap.innerHTML = "<div class='muted'>Belum ada aktivitas</div>";
    return;
  }
  const list = document.createElement("div");
  list.className = "timeline-list";
  arr.forEach((it, idx) => {
    const item = document.createElement("div"); item.className = "timeline-item";
    const thumb = document.createElement("div"); thumb.className="thumb"; 
    thumb.innerHTML = it.photo ? `<img src="${it.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">` : (it.type==='keluar'||it.type==='pulang' ? "ü§≥" : "üì∑");
    const meta = document.createElement("div"); meta.className="meta";
    const who = it.person==='A'?profile.nameA:profile.nameB;
    const title = document.createElement("h4"); title.innerText = `${who} ‚Äî ${it.type.toUpperCase()}`;
    const txt = document.createElement("p"); txt.innerHTML = `${it.timeStr} ‚Ä¢ ${it.location || ""}`;
    const desc = document.createElement("div"); desc.className="t"; desc.innerText = it.photo ? "Foto tersimpan" : "Tanpa foto";
    const ctr = document.createElement("div"); ctr.className="controls-inline";
    const del = document.createElement("button"); del.className="tiny"; del.innerText="Hapus"; del.onclick = ()=>{ if(confirm("Hapus catatan ini?")){ const pos = data.indexOf(it); if(pos>-1) data.splice(pos,1); saveAll(); renderTimeline(); } };
    ctr.appendChild(del);
    meta.appendChild(title); meta.appendChild(txt); meta.appendChild(desc); meta.appendChild(ctr);
    item.appendChild(thumb); item.appendChild(meta);
    list.appendChild(item);
  });
  wrap.appendChild(list);
}

/* upload activity */
function uploadActivity(){
  const person = document.getElementById("actPerson").value;
  const note = document.getElementById("actNote").value || "";
  const input = document.getElementById("actFile");
  if(!input.files || !input.files[0]) return alert("Pilih foto sebelum upload");
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = ()=>{
    const photo = reader.result;
    const now = new Date();
    const rec = {person,type:"activity",timeISO:now.toISOString(),timeStr:now.toLocaleString(),note,photo};
    acts.push(rec);
    saveAll();
    input.value="";
    toast("Upload aktivitas berhasil");
    renderGallery();
  };
  reader.readAsDataURL(file);
}

/* render gallery/storage summary */
function renderGallery(){
  // show acts in timelineWrap below data entries
  const wrap = document.getElementById("timelineWrap");
  const listWrap = document.createElement("div");
  listWrap.className = "card";
  listWrap.innerHTML = "<strong>Galeri Aktivitas</strong>";
  if(acts.length===0){ listWrap.innerHTML += "<div class='muted' style='margin-top:8px'>Belum ada foto aktivitas</div>"; wrap.appendChild(listWrap); return; }
  const grid = document.createElement("div"); grid.style.display="grid"; grid.style.gridTemplateColumns="repeat(auto-fit,minmax(160px,1fr))"; grid.style.gap="8px"; grid.style.marginTop="8px";
  acts.slice().reverse().forEach((a,i)=>{
    const c = document.createElement("div"); c.style.background="#fff"; c.style.padding="8px"; c.style.borderRadius="10px"; c.style.border="1px solid #eef8f2";
    c.innerHTML = `<div style="font-weight:700">${a.person==='A'?profile.nameA:profile.nameB}</div><div class="muted" style="font-size:12px">${a.timeStr}</div><img src="${a.photo}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-top:6px"/><div style="margin-top:6px"><div class="muted" style="font-size:13px">${a.note||''}</div><div style="margin-top:6px"><button class="tiny" onclick='deleteAct(${i})'>Hapus</button></div></div>`;
    grid.appendChild(c);
  });
  listWrap.appendChild(grid);
  wrap.appendChild(listWrap);
}

function deleteAct(idx){
  if(!confirm("Hapus foto aktivitas?")) return;
  acts.splice(idx,1); saveAll(); renderTimeline();
}

/* storage estimate */
function updateStorageEstimate(){
  // quick estimate size in KB for localStorage keys used
  const raw = JSON.stringify(localStorage);
  const bytes = raw ? (new Blob([raw]).size) : 0;
  const kb = Math.round(bytes/1024);
  document.getElementById("storageEst").innerText = kb + " KB used";
}
updateStorageEstimate();

/* cleanup old photos heuristic: remove oldest activity photos older than 30 days */
function cleanOldPhotos(){
  const cutoff = Date.now() - (30*24*60*60*1000);
  const before = acts.length;
  acts = acts.filter(a => new Date(a.timeISO).getTime() >= cutoff);
  saveAll();
  renderTimeline();
  toast(`Bersihkan selesai. Hapus ${before - acts.length} file`);
}

/* reset all */
function resetAll(){
  if(!confirm("Reset akan menghapus semua data lokal. Lanjut?")) return;
  data=[]; acts=[]; saveAll(); renderTimeline(); toast("Semua data dihapus");
}

/* backup/restore */
function downloadBackup(){
  const payload = {data, acts, profile};
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="dp_backup.json"; a.click();
  URL.revokeObjectURL(url);
}
function importBackup(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(Array.isArray(obj.data)) data = obj.data;
      if(Array.isArray(obj.acts)) acts = obj.acts;
      if(obj.profile) profile = obj.profile;
      saveAll(); applyProfileToUI(); renderTimeline(); toast("Restore berhasil");
    }catch(err){ alert("File tidak valid"); }
  };
  r.readAsText(f);
}

/* init render on load if already logged out */
(function init(){
  applyProfileToUI();
  if(data.length > 0) renderTimeline();
  updateStorageEstimate();
})();

/* helpers for developer console */
window._dp = {data,acts,profile,saveAll,renderTimeline};

</script>
</body>
</html>
