<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diary Pasangan ‚Äî Absensi & Perjalanan</title>
<meta name="theme-color" content="#ff7fb5"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#fff5f9; --card:#fff; --text:#3b0f2f; --muted:#7a5668;
    --accent:#ff6fa3; --accent-2:#ff7fb5; --success:#10b981; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text);padding:16px}
  .container{max-width:1000px;margin:0 auto}
  .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{margin:0 0 8px}
  label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #f2d7e1;background:#fff}
  textarea{min-height:90px;resize:vertical}
  button{cursor:pointer;border:0;padding:10px 12px;border-radius:10px;color:#fff}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .btn-green{background:var(--success)}
  .btn-red{background:var(--danger)}
  .row{display:flex;gap:10px;align-items:center}
  .col{flex:1}
  .small{font-size:13px;color:var(--muted)}
  .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .grid-2{display:grid;grid-template-columns:1fr 380px;gap:12px}
  @media(max-width:900px){ .grid-2{grid-template-columns:1fr} }
  .log-item{border-radius:10px;padding:10px;border:1px solid #fde8f3;background:rgba(255,127,181,0.05);margin-bottom:8px}
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cal-day{padding:8px;border-radius:8px;border:1px solid #ffeef6;min-height:70px;background:#fff}
  .cal-day.has{border-color:var(--accent);box-shadow:0 6px 18px rgba(255,127,181,0.06)}
  .badge{display:inline-block;background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff3f6;color:var(--accent);font-weight:700}
  .hidden{display:none}
  img.photo{max-width:100%;border-radius:8px;margin-top:8px}
  .muted{color:var(--muted)}
  .footer{font-size:13px;text-align:center;color:var(--muted);margin-top:16px}
</style>
</head>
<body>
<div class="container">

  <h1>üíñ Diary Pasangan ‚Äî Absensi & Perjalanan</h1>
  <div class="small muted">Data tersimpan di browser Anda. Tidak ada server. Fitur: PIN per pasangan, absensi kamera+GPS, upload foto, kalender, grafik, laporan.</div>

  <!-- LOCK / LOGIN -->
  <div id="lockCard" class="card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999;background:linear-gradient(180deg,rgba(255,247,250,0.9),rgba(255,247,250,0.95));">
    <div style="width:420px;max-width:96%">
      <h2>üîê Masuk ke Diary Pasangan</h2>
      <label>Masuk sebagai</label>
      <select id="loginAs"><option value="A">Pasangan A</option><option value="B">Pasangan B</option><option value="admin">Admin</option></select>
      <label>PIN</label>
      <input id="pinInput" type="password" placeholder="Masukkan PIN">
      <div class="row" style="margin-top:12px">
        <button class="btn-primary" onclick="checkPin()">Masuk</button>
        <button class="btn-red" onclick="openSettings()">Pengaturan</button>
      </div>
      <div class="muted small" style="margin-top:10px">PIN default: admin=1234, A=1111, B=2222</div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="top">
      <div style="flex:1">
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div style="min-width:140px">
              <label>Nama Pasangan A</label>
              <input id="nameA" type="text" placeholder="Nama A">
            </div>
            <div style="min-width:140px">
              <label>Nama Pasangan B</label>
              <input id="nameB" type="text" placeholder="Nama B">
            </div>
            <div style="min-width:140px">
              <label>Notifikasi (menit)</label>
              <input id="notifMinutes" type="number" min="1" value="60">
            </div>
            <div style="margin-left:auto">
              <button class="btn-primary" onclick="saveProfile()">Simpan Profil</button>
            </div>
          </div>
          <div class="small muted" style="margin-top:8px">PIN per pasangan dapat diubah di Kelola PIN.</div>
        </div>
      </div>

      <div style="width:360px">
        <div class="card">
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn-primary" onclick="requestNotificationPermission()">Izinkan Notifikasi</button>
            <button class="btn-primary" onclick="openPinManager()">Kelola PIN</button>
            <button class="btn-red" onclick="triggerSOS()">üî¥ SOS (kirim lokasi)</button>
          </div>
          <div id="sosInfo" class="small muted" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <!-- left -->
      <div>
        <div class="card">
          <h3>Aksi & Diary</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="flex:1">
              <div style="display:flex;gap:8px">
                <button class="btn-red" onclick="startAbsence('A','keluar')">A Keluar</button>
                <button class="btn-green" onclick="startAbsence('A','pulang')">A Pulang</button>
              </div>
              <div class="small muted" id="statusA">Status A: -</div>
              <label style="margin-top:8px">Diary A (pribadi)</label>
              <textarea id="diaryA"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button onclick="saveDiary('A')" class="btn-primary">Simpan Diary A</button>
                <button onclick="downloadDiary('A')" class="btn-primary">Unduh A</button>
              </div>
            </div>

            <div style="flex:1">
              <div style="display:flex;gap:8px">
                <button class="btn-red" onclick="startAbsence('B','keluar')">B Keluar</button>
                <button class="btn-green" onclick="startAbsence('B','pulang')">B Pulang</button>
              </div>
              <div class="small muted" id="statusB">Status B: -</div>
              <label style="margin-top:8px">Diary B (pribadi)</label>
              <textarea id="diaryB"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button onclick="saveDiary('B')" class="btn-primary">Simpan Diary B</button>
                <button onclick="downloadDiary('B')" class="btn-primary">Unduh B</button>
              </div>
            </div>
          </div>

          <hr style="margin:12px 0">

          <h4>üì∏ Foto Aktivitas Harian</h4>
          <div class="row" style="margin-top:8px">
            <select id="dailyPerson"><option value="A">A</option><option value="B">B</option></select>
            <input id="dailyNote" type="text" placeholder="Keterangan (opsional)">
            <button class="btn-primary" onclick="openDailyCamera()">Upload Foto</button>
          </div>
          <div id="dailyGallery" style="margin-top:10px"></div>

        </div>

        <div class="card" style="margin-top:12px">
          <h4>Timeline Terbaru</h4>
          <div id="timeline" style="max-height:240px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>

      <!-- right -->
      <div>
        <div class="card">
          <h3>Kalender Aktivitas & Grafik</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <button onclick="prevMonth()" class="btn-primary">‚óÄ</button>
            <div style="flex:1;display:flex;gap:8px">
              <select id="monthSel" onchange="renderCalendar()"></select>
              <select id="yearSel" onchange="renderCalendar()"></select>
            </div>
            <button onclick="nextMonth()" class="btn-primary">‚ñ∂</button>
          </div>

          <div id="calendar" class="cal"></div>

          <h4 style="margin-top:12px">Grafik sesi pulang per hari</h4>
          <canvas id="chart" height="140" style="margin-top:8px"></canvas>
          <div class="small muted" style="margin-top:8px">Klik hari di kalender untuk lihat detail & cetak laporan.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Backup & Export</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-primary" onclick="downloadBackup()">Unduh Backup (JSON)</button>
            <button class="btn-primary" onclick="document.getElementById('importFile').click()">Restore dari File</button>
            <button class="btn-primary" onclick="exportCSV()">Export CSV</button>
            <button class="btn-green" onclick="printDaily()">Cetak Laporan Hari Ini</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none" onchange="restoreFromFile(event)">
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button onclick="showRaw()" class="btn-primary">Tampilkan Raw Data</button>
        <button onclick="hideRaw()" class="btn-primary">Sembunyikan Raw</button>
        <button onclick="resetAll()" class="btn-red">Reset Semua Data</button>
      </div>
      <pre id="raw" class="hidden" style="margin-top:8px;white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
    </div>

    <div class="footer">Diary Pasangan ‚Äî Data hanya tersimpan di perangkat ini ¬∑ Jangan lupa backup</div>
  </div><!-- end app -->

</div><!-- end container -->

<!-- hidden inputs for camera -->
<input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none"/>
<input id="dailyCamera" type="file" accept="image/*" capture="environment" style="display:none"/>

<script>
/* =========================
   Diary Pasangan ‚Äî Single File Full
   ========================= */

/* STORAGE KEYS */
const KEY_DATA = "dp_data_v1";
const KEY_NAMES = "dp_names_v1";
const KEY_PINS = "dp_pins_v1";
const KEY_DAILY = "dp_daily_v1";
const KEY_SETTINGS = "dp_settings_v1";

/* DEFAULTS */
let names = JSON.parse(localStorage.getItem(KEY_NAMES)) || {A:"Pasangan A", B:"Pasangan B"};
let pins = JSON.parse(localStorage.getItem(KEY_PINS)) || {admin:"1234", A:"1111", B:"2222"};
let data = JSON.parse(localStorage.getItem(KEY_DATA)) || []; // records: {person, type, timeISO, timeStr, loc, photo, note, durationMs}
let dailyPhotos = JSON.parse(localStorage.getItem(KEY_DAILY)) || [];
let settings = JSON.parse(localStorage.getItem(KEY_SETTINGS)) || {notifMinutes:60, idleMinutes:0};

/* UI refs */
const lockCard = document.getElementById("lockCard");
const app = document.getElementById("app");
const loginAs = document.getElementById("loginAs");
const pinInput = document.getElementById("pinInput");
const nameA = document.getElementById("nameA");
const nameB = document.getElementById("nameB");
const notifMinutes = document.getElementById("notifMinutes");
const diaryA = document.getElementById("diaryA");
const diaryB = document.getElementById("diaryB");
const timeline = document.getElementById("timeline");
const dailyGallery = document.getElementById("dailyGallery");
const dailyCamera = document.getElementById("dailyCamera");
const cameraInput = document.getElementById("cameraInput");
const rawBox = document.getElementById("raw");
const sosInfo = document.getElementById("sosInfo");

/* calendar data */
const monthSel = document.getElementById("monthSel");
const yearSel = document.getElementById("yearSel");
const monthNames = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
const today = new Date();
let calMonth = today.getMonth(), calYear = today.getFullYear();

/* chart */
const ctx = document.getElementById("chart").getContext('2d');
let chart = new Chart(ctx, {
  type:'bar',
  data:{labels:[],datasets:[{label:'Pulang per hari',data:[],backgroundColor:[]}]},
  options:{responsive:true,maintainAspectRatio:false}
});

/* INIT UI VALUES */
nameA.value = names.A; nameB.value = names.B; notifMinutes.value = settings.notifMinutes;
for(let m=0;m<12;m++){ const o=document.createElement("option"); o.value=m; o.text=monthNames[m]; if(m===calMonth) o.selected=true; monthSel.appendChild(o); }
for(let y=today.getFullYear()-2;y<=today.getFullYear()+2;y++){ const o=document.createElement("option"); o.value=y; o.text=y; if(y===calYear) o.selected=true; yearSel.appendChild(o); }

/* UTILS */
function saveAll(){ localStorage.setItem(KEY_DATA, JSON.stringify(data)); localStorage.setItem(KEY_NAMES, JSON.stringify(names)); localStorage.setItem(KEY_PINS, JSON.stringify(pins)); localStorage.setItem(KEY_DAILY, JSON.stringify(dailyPhotos)); localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); }
function timeNow(){ const d=new Date(); return {iso:d.toISOString(),str:d.toLocaleString()}; }
function notify(title,body){ if("Notification" in window && Notification.permission==='granted'){ try{ new Notification(title,{body}); }catch(e){} } }

/* LOGIN */
function checkPin(){
  const who = loginAs.value;
  const val = pinInput.value||"";
  if(pins[who] && val===pins[who]){
    lockCard.style.display='none'; app.classList.remove('hidden');
    initAfterLogin();
  } else {
    alert("PIN salah");
  }
}

/* SETTINGS (admin) */
function openSettings(){
  const p = prompt("Masukkan PIN Admin:");
  if(p === pins.admin){
    lockCard.style.display='none'; app.classList.remove('hidden');
    initAfterLogin();
    // admin: open pin manager automatically
    setTimeout(()=>openPinManager(),200);
  } else {
    alert("PIN admin salah");
  }
}

/* PROFILE & PINS */
function saveProfile(){
  names.A = nameA.value||"Pasangan A"; names.B = nameB.value||"Pasangan B";
  settings.notifMinutes = Number(notifMinutes.value)||60;
  saveAll(); alert("Profil tersimpan");
}
function openPinManager(){
  const which = prompt("Ganti PIN untuk: admin / A / B ?");
  if(!which) return;
  const key = which.toLowerCase();
  if(!pins[key]) return alert("Pilihan tidak valid");
  const oldp = prompt("Masukkan PIN lama:");
  if(oldp !== pins[key]) return alert("PIN lama salah");
  const neu = prompt("Masukkan PIN baru (min 4):");
  if(!neu || neu.length<4) return alert("PIN minimal 4");
  pins[key] = neu; saveAll(); alert("PIN berhasil diubah");
}

/* ABSENSI: start with prompt PIN, then open camera, then save with GPS */
let pendingAbs = null;
function startAbsence(person,type){
  const promptPin = prompt("Masukkan PIN untuk " + (person==='A'?names.A:names.B));
  if(!promptPin) return;
  if(promptPin !== pins[person]) return alert("PIN salah");
  pendingAbs = {person,type};
  // open camera input
  cameraInput.click();
}
cameraInput.addEventListener('change', function(e){
  const file = e.target.files[0]; if(!file || !pendingAbs) { cameraInput.value=""; return; }
  const reader = new FileReader();
  reader.onload = function(){
    const photo = reader.result;
    const t = timeNow();
    if(!navigator.geolocation){ pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,"Lokasi tidak tersedia",photo); pendingAbs=null; cameraInput.value=""; return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const loc = pos.coords.latitude.toFixed(6)+","+pos.coords.longitude.toFixed(6);
      pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,loc,photo);
      pendingAbs=null; cameraInput.value="";
    }, err=>{
      pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,"Lokasi gagal",photo);
      pendingAbs=null; cameraInput.value="";
    }, {enableHighAccuracy:true, timeout:8000});
  };
  reader.readAsDataURL(file);
});

/* push record and schedule notif */
let pendingStart = {}; let notifTimers = {};
function pushRecord(person,type,iso,str,loc,photo){
  const rec = {person,type,timeISO:iso,timeStr:str,location:loc,photo};
  if(type==='keluar'){ pendingStart[person] = Date.now(); scheduleReminder(person); }
  if(type==='pulang'){ if(pendingStart[person]){ rec.durationMs = Date.now() - pendingStart[person]; delete pendingStart[person]; } clearReminder(person); }
  data.push(rec); saveAll(); render();
  notify("Absensi tersimpan", (names[person]||person)+" "+type);
}
function scheduleReminder(person){
  clearReminder(person);
  const mins = Number(notifMinutes.value)||settings.notifMinutes;
  if(Notification.permission !== 'granted') return;
  notifTimers[person] = setTimeout(()=>{ notify("Pengingat: belum pulang", (names[person]||person)+" belum tercatat pulang"); }, mins*60000);
}
function clearReminder(person){ if(notifTimers[person]){ clearTimeout(notifTimers[person]); delete notifTimers[person]; } }
function clearAllReminders(){ Object.keys(notifTimers).forEach(k=>clearReminder(k)); }

/* Daily photos */
const dailyCameraInput = document.getElementById("dailyCamera");
dailyCameraInput.addEventListener('change', function(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = function(){ dailyPhotos.push({id:Date.now(),person:document.getElementById('dailyPerson').value,note:document.getElementById('dailyNote').value||'',time:timeNow().str,photo:reader.result}); saveAll(); renderDaily(); document.getElementById('dailyNote').value=''; dailyCameraInput.value=''; }
  reader.readAsDataURL(f);
});
function openDailyCamera(){ dailyCameraInput.click(); }
function renderDaily(){ dailyGallery.innerHTML=''; dailyPhotos.slice().reverse().forEach(d=>{ const div=document.createElement('div'); div.className='log-item'; div.innerHTML=`<div style="font-weight:700">${names[d.person]} ‚Äî <span class="small muted">${d.time}</span></div><div class="small">Keterangan: ${d.note}</div><img class="photo" src="${d.photo}"/><div style="margin-top:8px"><button class="btn-primary" onclick="deleteDaily(${d.id})">Hapus</button></div>`; dailyGallery.appendChild(div); }); }

/* RENDER timeline & lists */
function render(){
  // timeline
  timeline.innerHTML=''; data.slice().reverse().forEach((r,idx)=>{
    const el = document.createElement('div'); el.className='log-item';
    const mapLink = (r.location && r.location.indexOf(",")>-1) ? ` <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.location)}">Maps</a>` : '';
    el.innerHTML = `<div style="font-weight:700">${names[r.person]||r.person} ‚Äî <span style="color:${r.type==='keluar'? 'var(--danger)' : 'var(--success)'}">${r.type.toUpperCase()}</span></div><div class="small">${r.timeStr}</div><div class="small">Lokasi: ${r.location || '-'} ${mapLink}</div>${r.photo?'<img class="photo" src="'+r.photo+'">':''}${r.durationMs?'<div class="small muted">Durasi: '+Math.round(r.durationMs/60000)+' menit</div>':''}<div style="margin-top:6px"><button class="btn-primary" onclick="deleteRecord(' + idx + ')">Hapus</button></div>`;
    timeline.appendChild(el);
  });

  // diary textareas
  diaryA.value = localStorage.getItem('dp_diary_A') || '';
  diaryB.value = localStorage.getItem('dp_diary_B') || '';
  // statuses
  document.getElementById('statusA').innerText = pendingStart['A'] ? 'A sedang keluar (timer aktif)' : 'Status A: -';
  document.getElementById('statusB').innerText = pendingStart['B'] ? 'B sedang keluar (timer aktif)' : 'Status B: -';
  renderCalendar(); updateChart(); renderDaily();
}

/* delete & download */
function deleteRecord(idx){ if(!confirm('Hapus catatan?')) return; data.splice(idx,1); saveAll(); render(); }
function deleteDaily(id){ if(!confirm('Hapus foto aktivitas?')) return; dailyPhotos = dailyPhotos.filter(x=>x.id!==id); saveAll(); renderDaily(); }

/* diaries */
function saveDiary(person){
  const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B';
  const val = person==='A' ? diaryA.value : diaryB.value;
  localStorage.setItem(key,val); alert('Diary tersimpan');
}
function downloadDiary(person){
  const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B';
  const blob = new Blob([localStorage.getItem(key) || ''], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'diary_'+person+'.txt'; a.click(); URL.revokeObjectURL(a.href);
}

/* calendar and chart */
function renderCalendar(){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  const month = Number(monthSel.value); const year=Number(yearSel.value);
  const first = new Date(year,month,1); const start = first.getDay(); const days = new Date(year,month+1,0).getDate();
  for(let i=0;i<start;i++){ const blank = document.createElement('div'); blank.className='cal-day'; cal.appendChild(blank); }
  for(let d=1; d<=days; d++){
    const dateISO = new Date(year,month,d).toISOString().slice(0,10);
    const events = data.filter(e=>e.timeISO.slice(0,10)===dateISO);
    const day = document.createElement('div'); day.className='cal-day'; if(events.length) day.classList.add('has');
    day.innerHTML = `<div style="font-weight:700">${d} <span class="small muted">${monthNames[month]}</span> ${events.length?'<span class="badge">'+events.length+'</span>':''}</div>`;
    day.onclick = ()=> openDay(dateISO);
    cal.appendChild(day);
  }
}
function prevMonth(){ let m=Number(monthSel.value), y=Number(yearSel.value); m--; if(m<0){m=11;y--;} monthSel.value=m; yearSel.value=y; renderCalendar(); }
function nextMonth(){ let m=Number(monthSel.value), y=Number(yearSel.value); m++; if(m>11){m=0;y++;} monthSel.value=m; yearSel.value=y; renderCalendar(); }
function updateChart(){
  const month = Number(monthSel.value), year = Number(yearSel.value);
  const days = new Date(year,month+1,0).getDate();
  const labels=[], counts=[], colors=[];
  for(let d=1; d<=days; d++){
    labels.push(String(d));
    const iso = new Date(year,month,d).toISOString().slice(0,10);
    const cnt = data.filter(it=>it.timeISO.slice(0,10)===iso && it.type==='pulang').length;
    counts.push(cnt); colors.push('#ff7fb5');
  }
  chart.data.labels = labels; chart.data.datasets[0].data = counts; chart.data.datasets[0].backgroundColor = colors; chart.update();
}

/* open day detail & print */
function openDay(dateISO){
  const events = data.filter(e=>e.timeISO.slice(0,10)===dateISO);
  let html = `<h2>Laporan ${dateISO}</h2><p>${names.A} & ${names.B}</p><hr>`;
  if(events.length===0) html += '<p>Tidak ada aktivitas</p>';
  events.forEach(ev=> html += `<div><b>${names[ev.person]}</b> ‚Äî ${ev.type.toUpperCase()}<br>${ev.timeStr}<br>Lokasi: ${ev.location || '-'}<br>${ev.photo?'<img style="max-width:240px;border-radius:8px;margin-top:6px" src="'+ev.photo+'"/>':''}${ev.durationMs?'<div>Durasi: '+Math.round(ev.durationMs/60000)+' menit</div>':''}</div><hr>`);
  const w = window.open('','_blank'); w.document.write(`<html><head><title>Report ${dateISO}</title><meta name="viewport" content="width=device-width,initial-scale=1"/></head><body>${html}</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),600);
}

/* export/backup */
function downloadBackup(){
  const blob = new Blob([JSON.stringify({data,names,pins,dailyPhotos,settings},null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dp_backup.json'; a.click(); URL.revokeObjectURL(a.href);
}
function restoreFromFile(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(obj.data) data = obj.data; if(obj.names) names = obj.names; if(obj.pins) pins = obj.pins; if(obj.dailyPhotos) dailyPhotos = obj.dailyPhotos; if(obj.settings) settings = obj.settings;
      saveAll(); render(); alert('Restore berhasil');
    }catch(err){ alert('File tidak valid'); }
  }; r.readAsText(f);
}
function exportCSV(){
  let csv = 'person,type,timeISO,timeStr,location,durationMin,notes\n';
  buildSessions().forEach(s=> csv += `${s.person},session,${s.start},${s.end},-,${Math.round(s.durationMs/60000)},\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dp_rekap.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function printDaily(){ const todayISO = new Date().toISOString().slice(0,10); openDay(todayISO); }

/* sessions builder */
function buildSessions(){
  const by = {A:[],B:[]};
  data.forEach(d=>{ if(d.person==='A'||d.person==='B') by[d.person].push(d); });
  const sessions=[];
  Object.keys(by).forEach(p=>{
    const arr = by[p].sort((a,b)=>a.timeISO.localeCompare(b.timeISO));
    let open=null;
    arr.forEach(ev=>{
      if(ev.type==='keluar') open = ev;
      if(ev.type==='pulang' && open){ sessions.push({person:p,start:open.timeISO,end:ev.timeISO,durationMs:new Date(ev.timeISO)-new Date(open.timeISO)}); open=null; }
    });
  });
  return sessions;
}

/* analysis (simple offline) */
function runAnalysis(){
  const sessions = buildSessions();
  const totalA = sessions.filter(s=>s.person==='A').length;
  const totalB = sessions.filter(s=>s.person==='B').length;
  alert(`Sesi A: ${totalA}\nSesi B: ${totalB}`);
}

/* SOS */
function triggerSOS(){
  if(!navigator.geolocation) return alert('Lokasi tidak tersedia');
  navigator.geolocation.getCurrentPosition(pos=>{
    const loc = pos.coords.latitude.toFixed(6)+','+pos.coords.longitude.toFixed(6);
    const t = timeNow();
    data.push({person:'A',type:'sos',timeISO:t.iso,timeStr:t.str,location:loc});
    saveAll(); render();
    sosInfo.innerText = `SOS disimpan: ${t.str} (${loc})`;
    notify('SOS tersimpan','Lokasi darurat disimpan');
  }, ()=> alert('Gagal ambil lokasi'));
}

/* notifications permission */
function requestNotificationPermission(){
  if(!('Notification' in window)) return alert('Notifikasi tidak didukung browser ini');
  Notification.requestPermission().then(r=> alert('Permission: '+r));
}

/* raw & reset */
function showRaw(){ rawBox.classList.remove('hidden'); rawBox.textContent = JSON.stringify({data,names,pins,dailyPhotos,settings},null,2); }
function hideRaw(){ rawBox.classList.add('hidden'); }
function resetAll(){ if(!confirm('Hapus semua data lokal?')) return; data=[]; dailyPhotos=[]; names={A:'Pasangan A',B:'Pasangan B'}; pins={admin:'1234',A:'1111',B:'2222'}; saveAll(); render(); alert('Direset'); }

/* backup helpers */
function downloadJSON(obj,filename){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

/* INIT after login (common render) */
function initAfterLogin(){
  // refresh UI values
  nameA.value = names.A; nameB.value = names.B; notifMinutes.value = settings.notifMinutes;
  render(); updateChart();
}

/* camera upload daily open (exposed for button) */
function openDailyCamera(){ dailyCamera.click(); }

/* delete helper for daily */
function deleteDaily(id){ dailyPhotos = dailyPhotos.filter(i=>i.id!==id); saveAll(); renderDaily(); }

/* misc */
function downloadBackupAuto(){ downloadJSON({data,names,pins,dailyPhotos,settings}, 'dp_backup.json'); }

/* INIT */
(function(){
  // apply values
  monthSel.value = calMonth; yearSel.value = calYear;
  saveAll();
  // render if already logged in (optional)
  const already = false;
  if(!already){ lockCard.style.display='flex'; app.classList.add('hidden'); } else { lockCard.style.display='none'; app.classList.remove('hidden'); initAfterLogin(); }
  render();
})();

/* expose minimal functions in case console needed */
window.checkPin = checkPin;
window.openSettings = openSettings;
window.openPinManager = openPinManager;
window.startAbsence = startAbsence;
window.openDailyCamera = openDailyCamera;
window.saveDiary = saveDiary;
window.downloadDiary = downloadDiary;
window.saveProfile = saveProfile;
window.downloadBackup = downloadBackup;
window.restoreFromFile = restoreFromFile;
window.exportCSV = exportCSV;
window.printDaily = printDaily;
window.showRaw = showRaw;
window.hideRaw = hideRaw;
window.resetAll = resetAll;
window.requestNotificationPermission = requestNotificationPermission;
window.triggerSOS = triggerSOS;
</script>
</body>
</html>
