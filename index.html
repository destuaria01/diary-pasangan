<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Diary Pasangan ‚Äî Ultimate (Single File)</title>
<meta name="theme-color" content="#16a34a"/>

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* THEME: Bright premium green + accent */
  :root{
    --bg: linear-gradient(135deg,#ecfeff,#f0fff4,#fff7f7);
    --card:#ffffff;
    --muted:#6b7280;
    --text:#08332a;
    --accent-1:#22c55e;
    --accent-2:#06b6d4;
    --glass: rgba(255,255,255,0.7);
    --radius:14px;
    --shadow: 0 12px 30px rgba(2,6,23,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1100px;margin:12px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(90deg,rgba(34,197,94,0.12),rgba(6,182,212,0.06));box-shadow:var(--shadow)}
  .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
  h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:12px}
  @media(max-width:920px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff}
  textarea{min-height:88px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  .col{flex:1}
  button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;color:#fff;background:linear-gradient(90deg,var(--accent-1),var(--accent-2))}
  .btn-ghost{background:transparent;color:var(--text);border:1px solid #e6e6e6}
  .small{font-size:13px;color:var(--muted)}
  .log{max-height:260px;overflow:auto;margin-top:8px}
  .log-item{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.03);margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfffb)}
  img.thumb{max-width:100%;border-radius:10px;margin-top:8px}
  .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(34,197,94,0.12);color:var(--accent-1);font-weight:700}
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
  .cal-day{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);min-height:68px;background:#fff}
  .cal-day.has{box-shadow:0 6px 18px rgba(34,197,94,0.06);border-color:var(--accent-1)}
  .bottom-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;display:flex;gap:8px;background:rgba(255,255,255,0.9);padding:8px;border-radius:999px;box-shadow:var(--shadow);z-index:999}
  .hidden{display:none}
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:2000}
  .glass{backdrop-filter: blur(6px); padding:16px; border-radius:12px; background:rgba(255,255,255,0.06); color:#fff}
  pre{white-space:pre-wrap;word-break:break-word;background:#f8fafc;padding:10px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo">DP</div>
    <div>
      <h1>Diary Pasangan ‚Äî Ultimate</h1>
      <div class="muted">Privat ‚Ä¢ Offline-first ‚Ä¢ Siap jadi APK</div>
    </div>
    <div style="margin-left:auto" class="small" id="clock">‚Äî</div>
  </header>

  <!-- LOCK -->
  <div id="lockCard" class="card" style="margin-top:12px">
    <h2>üîê Masuk</h2>
    <label>Masuk sebagai</label>
    <select id="loginAs">
      <option value="A">Pasangan A</option>
      <option value="B">Pasangan B</option>
      <option value="admin">Admin</option>
    </select>
    <label>PIN</label>
    <input id="pinInput" type="password" placeholder="PIN">
    <div class="row" style="margin-top:8px">
      <button onclick="doLogin()">Masuk (PIN)</button>
      <button class="btn-ghost" id="bioBtn" onclick="loginWithBiometric()">Sidik Jari</button>
    </div>
    <div style="margin-top:8px" class="row">
      <button class="btn-ghost" onclick="openSettings()">Pengaturan</button>
      <button class="btn-ghost" onclick="requestNotificationPermission()">Notifikasi</button>
      <button class="btn-ghost" onclick="helpMode()">Bantuan</button>
    </div>
    <div class="small" style="margin-top:8px">PIN default: admin=1234, A=1111, B=2222. Jika ingin biometrik: daftar di Pengaturan.</div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="grid">
      <!-- left -->
      <div>
        <div class="card">
          <label>Nama Pasangan A</label><input id="nameA">
          <label>Nama Pasangan B</label><input id="nameB">
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="notifMins" type="number" min="1" value="60" style="width:120px">
            <button class="btn-ghost" onclick="saveProfile()">Simpan</button>
          </div>

          <hr style="margin:10px 0">

          <div>
            <h4>Mode Khusus</h4>
            <div style="display:flex;gap:8px;flex-direction:column">
              <button onclick="toggleTogether()">Kami Sedang Bersama</button>
              <button class="btn-ghost" onclick="togglePrivacy()">Mode Privasi Tinggi</button>
              <button class="btn-ghost" onclick="toggleAutoLock()">Toggle Auto-Lock</button>
            </div>
            <div class="small" style="margin-top:8px">Mode Privasi menyembunyikan foto & data sensitif; hanya Admin bisa matikan.</div>
          </div>

          <hr style="margin:10px 0">

          <div>
            <h4>Pesan & Chat (Offline)</h4>
            <input id="quickTo" placeholder="Kirim ke (A/B)">
            <input id="quickMsg" placeholder="Pesan singkat...">
            <div style="display:flex;gap:8px;margin-top:8px"><button onclick="sendQuick()">Kirim</button><button class="btn-ghost" onclick="clearMessages()">Bersihkan</button></div>
          </div>

          <hr style="margin:10px 0">
          <div>
            <h4>Voice Note</h4>
            <div class="row">
              <button onclick="startRecording()">Rekam</button><button class="btn-ghost" onclick="stopRecording()">Stop</button>
            </div>
            <div id="voiceList" style="margin-top:8px"></div>
          </div>

          <hr style="margin:10px 0">
          <div>
            <h4>Backup / Export</h4>
            <div style="display:flex;gap:8px">
              <button onclick="downloadBackup()">Unduh Backup</button>
              <button onclick="exportCSV()">Export CSV</button>
              <button onclick="exportPDF()">Export PDF</button>
            </div>
            <div style="margin-top:8px"><input id="importFile" type="file" accept="application/json" onchange="importJSON(event)"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Foto Aktivitas Harian</h4>
          <div class="row">
            <select id="dailyPerson"><option value="A">A</option><option value="B">B</option></select>
            <input id="dailyNote" placeholder="Keterangan (opsional)">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="dailyCamera" type="file" accept="image/*" capture="environment" class="hidden" onchange="onDailyPhoto(event)">
            <button onclick="document.getElementById('dailyCamera').click()">Upload Foto</button>
            <button class="btn-ghost" onclick="clearDaily()">Bersihkan</button>
          </div>
          <div id="dailyGallery" style="margin-top:8px;max-height:240px;overflow:auto"></div>
        </div>
      </div>

      <!-- right -->
      <div>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div>
              <button onclick="attemptAbs('A','keluar')">A Keluar</button>
              <button onclick="attemptAbs('A','pulang')">A Pulang</button>
            </div>
            <div style="display:flex;gap:8px">
              <span class="status-pill" id="timerA">Timer A: -</span>
              <span class="status-pill" id="timerB">Timer B: -</span>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <label>Diary A (pribadi)</label>
              <textarea id="diaryA"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px"><button onclick="saveDiary('A')">Simpan</button><button class="btn-ghost" onclick="downloadDiary('A')">Unduh</button></div>
            </div>
            <div style="flex:1">
              <label>Diary B (pribadi)</label>
              <textarea id="diaryB"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px"><button onclick="saveDiary('B')">Simpan</button><button class="btn-ghost" onclick="downloadDiary('B')">Unduh</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Timeline & Chat</h4>
          <div id="timeline" class="log"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Kalender & Grafik</h4>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-ghost" onclick="prevMonth()">‚óÄ</button>
            <select id="monthSel" onchange="renderCalendar()"></select>
            <select id="yearSel" onchange="renderCalendar()"></select>
            <button class="btn-ghost" onclick="nextMonth()">‚ñ∂</button>
          </div>
          <div id="calendar" class="cal"></div>
          <h4 style="margin-top:8px">Grafik: sesi pulang per hari</h4>
          <canvas id="chart" height="110"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="small">Versi: Ultimate ‚Ä¢ Semua data lokal</div>
            <div>
              <button class="btn-ghost" onclick="showRaw()">Raw</button>
              <button class="btn-ghost" onclick="resetAll()">Reset</button>
            </div>
          </div>
          <pre id="raw" class="hidden"></pre>
        </div>

      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="small">Diary Pasangan ‚Äî Private</div>
    <div style="width:10px"></div>
    <button class="btn-ghost" onclick="openPinManager()">Kelola PIN/Biometric</button>
  </div>

</div>

<!-- hidden inputs -->
<input id="absCamera" type="file" accept="image/*" capture="environment" class="hidden">
<input id="importFileHidden" type="file" accept="application/json" class="hidden">

<script>
/* =========================
   Diary Pasangan ‚Äî Ultimate Single File
   - Many features combined (client-side)
   - Keep it stable: safe default timeouts, size limits
   ========================= */

/* STORAGE KEY */
const KEY = "dp_ultimate_v1";

/* INITIAL STATE */
let STATE = JSON.parse(localStorage.getItem(KEY)) || {
  pins: { admin:"1234", A:"1111", B:"2222" },
  names: { A:"Pasangan A", B:"Pasangan B" },
  records: [],   // {person,type,timeISO,timeStr,loc,photo,durationMs}
  daily: [],     // {id,person,note,time,photo}
  messages: [],  // {from,to,text,time,voice?}
  voices: [],    // {id,from,to,time,blobUrl}
  pendingStart: {},
  settings: { notifMinutes:60, autoLockMins:5 },
  biometric: { registered:false, credentialId:null },
  privacy: { enabled:false, together:false },
  createdAt: new Date().toISOString()
};

/* UI Refs */
const lockCard = document.getElementById('lockCard');
const appEl = document.getElementById('app');
const loginAsEl = document.getElementById('loginAs');
const pinInput = document.getElementById('pinInput');
const bioBtn = document.getElementById('bioBtn');
const nameAEl = document.getElementById('nameA');
const nameBEl = document.getElementById('nameB');
const notifMinsEl = document.getElementById('notifMins');
const timerAEl = document.getElementById('timerA');
const timerBEl = document.getElementById('timerB');
const timelineEl = document.getElementById('timeline');
const dailyGalleryEl = document.getElementById('dailyGallery');
const rawEl = document.getElementById('raw');
const chartCtx = document.getElementById('chart').getContext('2d');
const monthSel = document.getElementById('monthSel');
const yearSel = document.getElementById('yearSel');

/* calendar vars */
const monthNames = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
const today = new Date();
let calMonth = today.getMonth(), calYear = today.getFullYear();

/* Chart */
let chart = new Chart(chartCtx, {
  type:'bar',
  data:{ labels:[], datasets:[{ label:'Pulang per hari', data:[], backgroundColor:[] }] },
  options:{ responsive:true, maintainAspectRatio:false }
});

/* clock */
setInterval(()=>{ document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

/* Helpers */
function saveState(){ localStorage.setItem(KEY, JSON.stringify(STATE)); }
function timeNow(){ const d=new Date(); return { iso:d.toISOString(), str:d.toLocaleString() }; }
function base64UrlEncode(buf){ const bytes = new Uint8Array(buf); let s=''; for(let i=0;i<bytes.length;i++) s+=String.fromCharCode(bytes[i]); return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function base64UrlDecode(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return Uint8Array.from(atob(s), c=>c.charCodeAt(0)); }

/* ---------- Biometric (WebAuthn) ---------- */
async function isWebAuthnAvailable(){ return !!(window.PublicKeyCredential && typeof window.PublicKeyCredential === 'function'); }
async function registerBiometric(){
  if(!await isWebAuthnAvailable()){ alert('WebAuthn tidak didukung'); return; }
  try{
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const userId = crypto.getRandomValues(new Uint8Array(16));
    const pub = {
      challenge,
      rp:{name:"DiaryPasangan"},
      user:{id:userId, name:"local-user", displayName:"DiaryUser"},
      pubKeyCredParams:[{alg:-7,type:'public-key'}],
      authenticatorSelection:{ authenticatorAttachment:"platform", userVerification:"preferred" },
      timeout:60000,
      attestation:'none'
    };
    const cred = await navigator.credentials.create({ publicKey: pub });
    if(!cred) return alert('Dibatalkan');
    STATE.biometric.registered = true;
    STATE.biometric.credentialId = base64UrlEncode(cred.rawId);
    saveState(); alert('Biometric terdaftar');
  }catch(err){ console.error(err); alert('Gagal daftar biometric: '+(err.message||err)); }
}
async function loginWithBiometric(){
  if(!STATE.biometric.registered) return alert('Belum ada biometric terdaftar');
  if(!await isWebAuthnAvailable()) return alert('WebAuthn tidak tersedia');
  try{
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const publicKey = { challenge, allowCredentials: [{ type:'public-key', id: base64UrlDecode(STATE.biometric.credentialId) }], timeout:60000, userVerification:'preferred' };
    const assertion = await navigator.credentials.get({ publicKey });
    if(assertion){
      const who = prompt('Biometric OK. Masuk sebagai (A/B/admin):','A');
      if(who && (who==='A'||who==='B'||who==='admin')) doLoginWith(who);
    }
  }catch(err){ console.error(err); alert('Autentikasi biometric gagal: '+(err.message||err)); }
}

/* ---------- Login & Settings ---------- */
let currentUser = null;
function doLogin(){
  const who = loginAsEl.value;
  const pin = pinInput.value||'';
  if(STATE.pins[who] && pin === STATE.pins[who]) { doLoginWith(who); } else alert('PIN salah');
}
function doLoginWith(who){
  currentUser = who;
  lockCard.style.display='none';
  appEl.classList.remove('hidden');
  nameAEl.value = STATE.names.A; nameBEl.value = STATE.names.B;
  notifMinsEl.value = STATE.settings.notifMinutes || 60;
  renderAll();
}
function openSettings(){
  const adm = prompt('Masukkan PIN Admin:');
  if(adm !== STATE.pins.admin) return alert('PIN admin salah');
  const choice = prompt('Pengaturan:\n1=Ganti Nama\n2=Daftar Biometric\n3=Hapus Biometric\n4=Ganti PIN\n5=Export Backup\nKetik nomor:','1');
  if(!choice) return;
  if(choice==='1'){ const na=prompt('Nama A:',STATE.names.A); const nb=prompt('Nama B:',STATE.names.B); if(na) STATE.names.A=na; if(nb) STATE.names.B=nb; saveState(); renderAll(); alert('Nama disimpan'); }
  else if(choice==='2') registerBiometric();
  else if(choice==='3'){ if(confirm('Hapus biometric?')){ STATE.biometric={registered:false,credentialId:null}; saveState(); alert('Dihapus'); } }
  else if(choice==='4'){ const who = prompt('PIN untuk (admin/A/B)','A'); if(!who||!STATE.pins[who]) return alert('Invalid'); const oldp = prompt('PIN lama:'); if(oldp!==STATE.pins[who]) return alert('PIN lama salah'); const neu = prompt('PIN baru (min4):'); if(!neu||neu.length<4) return alert('PIN minimal 4'); STATE.pins[who]=neu; saveState(); alert('PIN diubah'); }
  else if(choice==='5'){ downloadBackup(); }
  else alert('Pilihan tidak valid');
}

/* ---------- Profile & Modes ---------- */
function saveProfile(){ STATE.names.A = nameAEl.value || STATE.names.A; STATE.names.B = nameBEl.value || STATE.names.B; STATE.settings.notifMinutes = Number(notifMinsEl.value)||STATE.settings.notifMinutes; saveState(); alert('Profil tersimpan'); renderAll(); }
function togglePrivacy(){ const p = prompt('PIN Admin untuk toggle Mode Privasi:'); if(p!==STATE.pins.admin) return alert('PIN admin salah'); STATE.privacy.enabled = !STATE.privacy.enabled; saveState(); renderAll(); alert('Mode Privasi '+(STATE.privacy.enabled?'AKTIF':'NONAKTIF')); }
function toggleTogether(){ STATE.privacy.together = !STATE.privacy.together; const t = timeNow(); STATE.records.push({ person:'A', type:'together', timeISO:t.iso, timeStr:t.str, location:'-' }); saveState(); renderAll(); notify('Mode Bersama','Notifikasi pulang dinonaktifkan'); }
function toggleAutoLock(){ const m = prompt('Auto-lock menit (0 nonaktif):', String(STATE.settings.autoLockMins||5)); STATE.settings.autoLockMins = Number(m)||0; saveState(); alert('Auto-lock diatur'); }

/* ---------- Notifications ---------- */
function requestNotificationPermission(){ if(!('Notification' in window)) return alert('Notifikasi tidak didukung'); Notification.requestPermission().then(r=>alert('Permission: '+r)); }
function notify(title,body){ if('Notification' in window && Notification.permission==='granted'){ try{ new Notification(title,{body}); }catch(e){} } }

/* ---------- Absensi (camera + gps) ---------- */
let pendingAbs = null;
function attemptAbs(person,type){
  // require PIN
  const pin = prompt('Masukkan PIN untuk '+(person==='A'?STATE.names.A:STATE.names.B));
  if(pin !== STATE.pins[person]) return alert('PIN salah');
  pendingAbs = { person, type };
  // open camera file input
  document.getElementById('absCamera').click();
}
document.getElementById('absCamera').addEventListener('change', function(e){
  const f = e.target.files[0]; if(!f || !pendingAbs){ e.target.value=''; return; }
  // limit file size for stability
  if(f.size > 2_000_000){ alert('Foto terlalu besar (>2MB). Pilih foto lebih kecil.'); e.target.value=''; return; }
  const r = new FileReader();
  r.onload = ()=> {
    const photo = r.result;
    const t = timeNow();
    // attempt geolocation
    if(!navigator.geolocation){ pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,'Lokasi tidak tersedia',photo); pendingAbs=null; e.target.value=''; return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const loc = pos.coords.latitude.toFixed(6)+','+pos.coords.longitude.toFixed(6);
      pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,loc,photo);
      pendingAbs=null; e.target.value='';
    }, err=>{
      pushRecord(pendingAbs.person,pendingAbs.type,t.iso,t.str,'Lokasi gagal',photo); pendingAbs=null; e.target.value='';
    }, {enableHighAccuracy:true, timeout:10000});
  };
  r.readAsDataURL(f);
});

/* push record */
let notifTimers = {};
function pushRecord(person,type,iso,str,loc,photo){
  const rec = { person, type, timeISO:iso, timeStr:str, location:loc, photo };
  if(type==='keluar'){ STATE.pendingStart[person] = Date.now(); scheduleReminder(person); }
  if(type==='pulang'){ if(STATE.pendingStart[person]){ rec.durationMs = Date.now() - STATE.pendingStart[person]; delete STATE.pendingStart[person]; } clearReminder(person); }
  STATE.records.push(rec); saveState(); renderAll(); notify('Absensi tersimpan', (STATE.names[person]||person)+' '+type);
}
function scheduleReminder(person){
  clearReminder(person);
  const mins = Number(STATE.settings.notifMinutes) || 60;
  if('Notification' in window && Notification.permission==='granted'){
    notifTimers[person] = setTimeout(()=>{ new Notification('Pengingat pulang',{body:(STATE.names[person]||person)+' belum tercatat pulang'}); }, mins*60000);
  }
}
function clearReminder(person){ if(notifTimers[person]){ clearTimeout(notifTimers[person]); delete notifTimers[person]; } }

/* ---------- Daily photo ---------- */
function onDailyPhoto(e){
  const f = e.target.files[0]; if(!f) return;
  if(f.size > 2_000_000){ alert('Foto terlalu besar. Maks 2MB'); e.target.value=''; return; }
  const r = new FileReader();
  r.onload = ()=> {
    const t = timeNow();
    const obj = { id:Date.now(), person: document.getElementById('dailyPerson').value || 'A', note: document.getElementById('dailyNote').value||'', time: t.str, photo: r.result };
    STATE.daily.unshift(obj); saveState(); renderDaily(); e.target.value='';
  };
  r.readAsDataURL(f);
}
function clearDaily(){ if(!confirm('Hapus semua foto aktivitas?')) return; STATE.daily = []; saveState(); renderDaily(); }

/* ---------- Messages (offline chat) ---------- */
function sendQuick(){
  const to = document.getElementById('quickTo').value.trim().toUpperCase();
  const text = document.getElementById('quickMsg').value.trim();
  if(!to || (to!=='A' && to!=='B')) return alert('Tujuan harus A atau B');
  if(!text) return alert('Tulis pesan');
  const t = timeNow();
  STATE.messages.unshift({ from: currentUser||'A', to, text, time: t.str });
  saveState(); renderAll(); document.getElementById('quickMsg').value=''; notify('Pesan terkirim', text);
}
function clearMessages(){ if(!confirm('Hapus semua pesan?')) return; STATE.messages = []; saveState(); renderAll(); }

/* ---------- Voice notes using MediaRecorder ---------- */
let mediaRecorder, audioChunks=[];
async function startRecording(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert('Microphone tidak didukung');
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e=> audioChunks.push(e.data);
    mediaRecorder.onstop = ()=> {
      const blob = new Blob(audioChunks, { type:'audio/webm' });
      const url = URL.createObjectURL(blob);
      const t = timeNow();
      const entry = { id:Date.now(), from: currentUser||'A', to: prompt('Simpan voice note untuk (A/B)', 'B'), time: t.str, url };
      STATE.voices.unshift(entry); saveState(); renderVoices();
    };
    mediaRecorder.start();
    alert('Rekaman dimulai');
  }catch(err){ console.error(err); alert('Gagal akses microphone: '+(err.message||err)); }
}
function stopRecording(){ if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); alert('Rekaman berhenti'); } else alert('Belum merekam'); }
function renderVoices(){ const list = document.getElementById('voiceList'); list.innerHTML = STATE.voices.map(v=>`<div class="log-item"><div style="font-weight:700">${v.from} ‚Üí ${v.to}</div><div class="small">${v.time}</div><audio controls src="${v.url}"></audio><div style="margin-top:6px"><button class="btn-ghost" onclick="deleteVoice(${v.id})">Hapus</button></div></div>`).join(''); }
function deleteVoice(id){ STATE.voices = STATE.voices.filter(v=>v.id!==id); saveState(); renderVoices(); }

/* ---------- Diaries ---------- */
function saveDiary(person){ const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B'; const val = document.getElementById('diary'+person).value; localStorage.setItem(key, val); alert('Diary tersimpan'); }
function downloadDiary(person){ const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B'; const blob = new Blob([localStorage.getItem(key)||''], { type:'text/plain' }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = 'diary_'+person+'.txt'; a.click(); URL.revokeObjectURL(a.href); }

/* ---------- Calendar & Chart ---------- */
for(let m=0;m<12;m++){ const o=document.createElement('option'); o.value=m; o.text=monthNames[m]; if(m===calMonth) o.selected=true; monthSel.appendChild(o); }
for(let y=today.getFullYear()-2;y<=today.getFullYear()+2;y++){ const o=document.createElement('option'); o.value=y; o.text=y; if(y===calYear) o.selected=true; yearSel.appendChild(o); }
function renderCalendar(){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  const month = Number(monthSel.value), year = Number(yearSel.value);
  const first = new Date(year, month, 1), start = first.getDay(), days = new Date(year, month+1, 0).getDate();
  for(let i=0;i<start;i++){ const b=document.createElement('div'); b.className='cal-day'; cal.appendChild(b); }
  for(let d=1; d<=days; d++){
    const iso = new Date(year, month, d).toISOString().slice(0,10);
    const events = STATE.records.filter(r=>r.timeISO && r.timeISO.slice(0,10)===iso);
    const day = document.createElement('div'); day.className='cal-day'; if(events.length) day.classList.add('has');
    day.innerHTML = `<div style="font-weight:700">${d} <div class="small">${monthNames[month]}</div>${events.length?'<div class="badge">'+events.length+'</div>':''}</div>`;
    day.onclick = ()=> openDay(iso);
    cal.appendChild(day);
  }
}
function updateChart(){
  const month = Number(monthSel.value), year = Number(yearSel.value);
  const days = new Date(year, month+1, 0).getDate();
  const labels=[], dataArr=[], colors=[];
  for(let d=1; d<=days; d++){
    labels.push(String(d));
    const iso = new Date(year, month, d).toISOString().slice(0,10);
    const count = STATE.records.filter(r=>r.timeISO && r.timeISO.slice(0,10)===iso && r.type==='pulang').length;
    dataArr.push(count); colors.push('rgba(34,197,94,0.9)');
  }
  chart.data.labels = labels; chart.data.datasets[0].data = dataArr; chart.data.datasets[0].backgroundColor = colors; chart.update();
}
function prevMonth(){ let m=Number(monthSel.value), y=Number(yearSel.value); m--; if(m<0){m=11;y--;} monthSel.value=m; yearSel.value=y; renderCalendar(); }
function nextMonth(){ let m=Number(monthSel.value), y=Number(yearSel.value); m++; if(m>11){m=0;y++;} monthSel.value=m; yearSel.value=y; renderCalendar(); }

function openDay(dateISO){
  const events = STATE.records.filter(e=>e.timeISO && e.timeISO.slice(0,10)===dateISO);
  let html = `<h2>Laporan ${dateISO}</h2><p>${STATE.names.A} & ${STATE.names.B}</p><hr>`;
  if(events.length===0) html += '<p>Tidak ada aktivitas</p>';
  events.forEach(ev=> html += `<div><b>${STATE.names[ev.person]||ev.person}</b> ‚Äî ${ev.type.toUpperCase()}<br>${ev.timeStr}<br>Lokasi: ${ev.location||'-'}${ev.photo?'<br><img style="max-width:240px;border-radius:8px;margin-top:6px" src="'+ev.photo+'">':''}${ev.durationMs?`<div>Durasi: ${Math.round(ev.durationMs/60000)} menit</div>`:''}</div><hr>`);
  const w = window.open('','_blank'); w.document.write(`<html><head><title>Laporan ${dateISO}</title><meta name="viewport" content="width=device-width,initial-scale=1"/></head><body style="font-family:Arial">${html}</body></html>`); w.document.close(); setTimeout(()=>w.print(),600);
}

/* ---------- Export & PDF ---------- */
function downloadBackup(){
  const blob = new Blob([JSON.stringify(STATE,null,2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dp_backup.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importJSON(e){ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=> { try{ const obj = JSON.parse(r.result); if(obj && obj.pins){ STATE = obj; saveState(); renderAll(); alert('Restore berhasil'); } else alert('File tidak cocok'); } catch(err){ alert('File tidak valid'); } }; r.readAsText(f); }
function exportCSV(){
  let csv='person,type,timeISO,timeStr,location,durationMin\n';
  const sessions = buildSessions();
  sessions.forEach(s=> csv += `${s.person},session,${s.start},${s.end},-,${Math.round(s.durationMs/60000)}\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dp_rekap.csv'; a.click(); URL.revokeObjectURL(a.href);
}
async function exportPDF(){
  // simple daily PDF using jsPDF
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14); doc.text('Laporan Harian - Diary Pasangan', 14, 20);
    const iso = new Date().toISOString().slice(0,10);
    let y = 30;
    const events = STATE.records.filter(e => e.timeISO && e.timeISO.slice(0,10)===iso);
    if(events.length===0) { doc.text('Tidak ada aktivitas hari ini',14,y); }
    events.forEach(ev=>{
      doc.setFontSize(11);
      doc.text(`${STATE.names[ev.person]||ev.person} - ${ev.type.toUpperCase()} - ${ev.timeStr}`, 14, y);
      y += 8;
      doc.text(`Lokasi: ${ev.location||'-'}`, 14, y); y+=8;
      if(y>260){ doc.addPage(); y=20; }
    });
    doc.save(`laporan_${iso}.pdf`);
  }catch(err){ alert('PDF export gagal: '+(err.message||err)); }
}

/* ---------- Sessions builder ---------- */
function buildSessions(){
  const by = { A:[], B:[] };
  STATE.records.forEach(d=>{ if(d.person==='A'||d.person==='B') by[d.person].push(d); });
  const sessions=[];
  Object.keys(by).forEach(p=>{
    by[p].sort((a,b)=>a.timeISO.localeCompare(b.timeISO));
    let open=null;
    by[p].forEach(ev=>{
      if(ev.type==='keluar') open = ev;
      if(ev.type==='pulang' && open){ sessions.push({person:p,start:open.timeISO,end:ev.timeISO,durationMs:new Date(ev.timeISO)-new Date(open.timeISO)}); open=null; }
    });
  });
  return sessions;
}

/* ---------- Analysis (simple AI offline) ---------- */
function runAnalysis(){
  const sessions = buildSessions();
  const totalA = sessions.filter(s=>s.person==='A').length;
  const totalB = sessions.filter(s=>s.person==='B').length;
  const avgA = totalA ? Math.round(sessions.filter(s=>s.person==='A').reduce((a,b)=>a+b.durationMs,0)/totalA/60000) : 0;
  const avgB = totalB ? Math.round(sessions.filter(s=>s.person==='B').reduce((a,b)=>a+b.durationMs,0)/totalB/60000) : 0;
  alert(`Ringkasan:\nSesi A: ${totalA} (rata ${avgA} menit)\nSesi B: ${totalB} (rata ${avgB} menit)`);
}

/* ---------- Raw / Reset ---------- */
function showRaw(){ rawEl.classList.remove('hidden'); rawEl.textContent = JSON.stringify(STATE,null,2); }
function hideRaw(){ rawEl.classList.add('hidden'); }
function resetAll(){ if(!confirm('Hapus semua data lokal?')) return; STATE = { pins:{ admin:'1234', A:'1111', B:'2222' }, names:{ A:'Pasangan A', B:'Pasangan B' }, records:[], daily:[], messages:[], voices:[], pendingStart:{}, settings:{ notifMinutes:60, autoLockMins:5 }, biometric:{ registered:false, credentialId:null }, privacy:{ enabled:false, together:false } }; saveState(); renderAll(); alert('Reset selesai'); }

/* ---------- Render functions ---------- */
function renderDaily(){ dailyGalleryEl.innerHTML = STATE.daily.map(d=>`<div class="log-item"><div style="font-weight:700">${STATE.names[d.person]} <span class="small">${d.time}</span></div><div class="small">${d.note}</div>${STATE.privacy.enabled?'<div class="small">[Foto tersembunyi]</div>':'<img class="thumb" src="'+d.photo+'"/>'}<div style="margin-top:6px"><button class="btn-ghost" onclick="deleteDaily(${d.id})">Hapus</button></div></div>`).join(''); }
function renderTimeline(){
  timelineEl.innerHTML = '';
  // merge records + messages + voices + daily into timeline sorted by time (approx)
  const items = [];
  STATE.records.forEach(r=> items.push({ t: r.timeISO||new Date().toISOString(), type:'rec', data:r }));
  STATE.messages.forEach(m=> items.push({ t: new Date().toISOString(), type:'msg', data:m }));
  STATE.daily.forEach(d=> items.push({ t: d.time || new Date().toISOString(), type:'daily', data:d }));
  STATE.voices.forEach(v=> items.push({ t: v.time||new Date().toISOString(), type:'voice', data:v }));
  items.sort((a,b)=> (''+b.t).localeCompare(a.t+''));
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='log-item';
    if(it.type==='rec'){
      const r=it.data;
      const mapLink = (r.location && r.location.indexOf(',')>-1) ? ` <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.location)}">Maps</a>` : '';
      const photoHtml = (r.photo && !STATE.privacy.enabled) ? `<img class="thumb" src="${r.photo}">` : (r.photo ? '<div class="small">[Foto tersembunyi]</div>' : '');
      div.innerHTML = `<div style="font-weight:700">${STATE.names[r.person]||r.person} ‚Äî <span style="color:${r.type==='keluar'?'#ef4444':'#10b981'}">${r.type.toUpperCase()}</span></div><div class="small">${r.timeStr}</div><div class="small">Lokasi: ${r.location||'-'} ${mapLink}</div>${photoHtml}${r.durationMs?'<div class="small">Durasi: '+Math.round(r.durationMs/60000)+' menit</div>':''}<div style="margin-top:6px"><button class="btn-ghost" onclick="deleteRecord('+STATE.records.indexOf(r)+')">Hapus</button></div>`;
    } else if(it.type==='msg'){
      const m = it.data; div.innerHTML = `<div style="font-weight:700">${m.from} ‚Üí ${m.to}</div><div class="small">${m.time}</div><div style="margin-top:6px">${m.text}</div>`;
    } else if(it.type==='daily'){
      const d=it.data; const photoHtml = STATE.privacy.enabled?'<div class="small">[Foto tersembunyi]</div>':'<img class="thumb" src="'+d.photo+'"/>'; div.innerHTML = `<div style="font-weight:700">${STATE.names[d.person]} <span class="small">${d.time}</span></div><div class="small">${d.note}</div>${photoHtml}<div style="margin-top:6px"><button class="btn-ghost" onclick="deleteDaily(${d.id})">Hapus</button></div>`;
    } else if(it.type==='voice'){
      const v=it.data; div.innerHTML = `<div style="font-weight:700">Voice ${v.from} ‚Üí ${v.to}</div><div class="small">${v.time}</div><audio controls src="${v.url}"></audio><div style="margin-top:6px"><button class="btn-ghost" onclick="deleteVoice(${v.id})">Hapus</button></div>`;
    }
    timelineEl.appendChild(div);
  });
}

/* ---------- CRUD helpers ---------- */
function deleteRecord(idx){ if(!confirm('Hapus catatan?')) return; STATE.records.splice(idx,1); saveState(); renderAll(); }
function deleteDaily(id){ STATE.daily = STATE.daily.filter(x=>x.id!==id); saveState(); renderDaily(); }
function deleteVoice(id){ STATE.voices = STATE.voices.filter(v=>v.id!==id); saveState(); renderVoices(); }

/* ---------- Diary save ---------- */
function saveDiaryUI(person){
  const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B';
  const val = document.getElementById('diary'+person).value;
  localStorage.setItem(key,val);
  alert('Diary tersimpan');
}

/* ---------- Backup/restore helpers ---------- */
function downloadBackup(){ const blob = new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dp_backup.json'; a.click(); URL.revokeObjectURL(a.href); }
function importJSON(event){ const f = event.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=> { try { const obj = JSON.parse(r.result); if(obj && obj.pins){ STATE = obj; saveState(); renderAll(); alert('Restore berhasil'); } else alert('File tidak cocok'); } catch(err){ alert('File tidak valid'); } }; r.readAsText(f); }

/* ---------- simple UI actions ---------- */
function saveProfileUI(){ STATE.names.A = nameAEl.value || STATE.names.A; STATE.names.B = nameBEl.value || STATE.names.B; STATE.settings.notifMinutes = Number(notifMinsEl.value)||STATE.settings.notifMinutes; saveState(); alert('Profil disimpan'); renderAll(); }
function changePinAll(){ openSettings(); } // uses settings prompt

/* ---------- Utility renderAll ---------- */
function renderAll(){
  // update UI values
  nameAEl.value = STATE.names.A; nameBEl.value = STATE.names.B; notifMinsEl.value = STATE.settings.notifMinutes || 60;
  renderDaily(); renderTimeline(); renderVoices();
  document.getElementById('timerA').innerText = STATE.pendingStart['A'] ? 'Timer A: aktif' : 'Timer A: -';
  document.getElementById('timerB').innerText = STATE.pendingStart['B'] ? 'Timer B: aktif' : 'Timer B: -';
  renderCalendar(); updateChart();
}

/* ---------- small helpers ---------- */
function attemptAbs(person,type){ attemptAbs(person,type); } // already defined above
// Avoid naming conflict for saveDiary UI:
window.saveDiary = function(person){ const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B'; const val = document.getElementById('diary'+person).value; localStorage.setItem(key,val); alert('Diary tersimpan'); };
window.downloadDiary = function(person){ const key = person==='A' ? 'dp_diary_A' : 'dp_diary_B'; const blob = new Blob([localStorage.getItem(key)||''], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='diary_'+person+'.txt'; a.click(); URL.revokeObjectURL(a.href); };

/* Expose functions for HTML */
window.doLogin = doLogin;
window.loginWithBiometric = loginWithBiometric;
window.openSettings = openSettings;
window.registerBiometric = registerBiometric;
window.startRecording = startRecording;
window.stopRecording = stopRecording;
window.sendQuick = sendQuick;
window.togglePrivacy = togglePrivacy;
window.toggleTogether = toggleTogether;
window.toggleAutoLock = toggleAutoLock;
window.saveProfile = saveProfileUI;
window.attemptAbs = attemptAbs;
window.onDailyPhoto = onDailyPhoto;
window.clearDaily = clearDaily;
window.downloadBackup = downloadBackup;
window.importJSON = importJSON;
window.exportCSV = exportCSV;
window.exportPDF = exportPDF;
window.showRaw = showRaw;
window.resetAll = resetAll;
window.openPinManager = openSettings;

/* ---------- INIT ---------- */
(function init(){
  // fill calendar selects
  monthSel.value = calMonth; yearSel.value = calYear;
  // show/hide biometric button based on support
  isWebAuthnAvailable().then(av => { if(!av) document.getElementById('bioBtn').style.display='none'; else document.getElementById('bioBtn').style.display='inline-block'; });
  // save initial
  saveState();
  // show lock
  lockCard.style.display='block';
  appEl.classList.add('hidden');
  renderAll();
  // gentle GC: limit daily and records length to avoid memory blow up
  if(STATE.daily.length>600) STATE.daily = STATE.daily.slice(0,600);
  if(STATE.records.length>1500) STATE.records = STATE.records.slice(0,1500);
  saveState();
})();

/* ---------- NOTES / LIMITATIONS ----------
- Live real-time tracking between two devices requires server or peer-to-peer signalling.
  Here we store 'last known location' in records; if you want live sharing, we can add a simple Firebase/Realtime or WebSocket server later.
- WebAuthn implemented client-side with local credential; this works on devices that support platform authenticators.
- Export to PDF uses jsPDF basic text; images may increase PDF size.
- Voice notes stored as blob URLs in memory; they persist in state only as URLs created during session. For persistent voice files, would need to encode as base64 (increases storage).
------------------------------------------- */

</script>
</body>
</html>
